##trying to make a network graph of my contacts

library(tidyverse)
library(magrittr)
library(igraph)
library(stringr)
library(RColorBrewer)
library(plotly)
library(visNetwork)

edges <- read.csv('~/Desktop/network_graph/edges.csv')
edges$source %<>% str_trim()
edges$target %<>% str_trim()

edges$last_date %<>% lubridate::mdy()
edges %<>% filter (Sys.Date() - last_date <= 31)

##make node graph from edges graph 
nodes <- data.frame(nodes = unique(edges$source), id = 1:length(unique(edges$source)))
nodes %<>% rbind(data.frame(nodes = unique(edges$target), id = 1:length(unique(edges$target))))

nodes %<>% filter(!duplicated(nodes))


g <- graph_from_data_frame(d=edges, vertices=nodes, directed=FALSE)
V(g) # nodes
vertex_attr(g) # all attributes of the nodes
g[] # adjacency matrix


coul  <- brewer.pal(4, "Set2") 

# Create a vector of color
my_color <- coul[as.numeric(as.factor(edges$vibe))]

set.seed(2)
par(mar=c(0,0,0,0))

plot(g,
     vertex.color = "white", # change color of nodes
     vertex.label.color = "black", # change color of labels
     vertex.label.cex = .75, # change size of labels to 75% of original size
     edge.curved=.20, # add a 25% curve to the edges
     edge.color=my_color,
     edge.width=log(edges$weight) *2 +1 ) # change edge color to grey


legend("bottomleft", legend=levels(as.factor(edges$vibe))  , col = coul , bty = "n", pch=10, text.col=coul , horiz = FALSE, inset = c(0.1, 0.1))


##try to make interactive
t <- toVisNetworkData(g, idToLabel = TRUE)
class(t)
t$edges$value <- log(t$edges$weight) * .6  + 4
t$edges$title <- paste(t$edges$weight, "day(s) last month")
t$edges$color <- coul[as.numeric(as.factor(t$edges$vibe))]
t$edges %<>% mutate(length = ifelse((weight == 30 | weight == 15),10,250))
ledges <- data.frame(color = unique(coul[as.numeric(as.factor(t$edges$vibe))]),
                     label = unique(t$edges$vibe))
set.seed(13)
visNetwork(nodes = t$nodes, edges = t$edges, physics = T, main = "Contacts In the Last Month") %>% 
  visNodes(shape = 'circle',
           color = list(background = "white", 
                        border = "darkblue",
                        highlight = "yellow")) %>% 
  visLegend(addEdges = ledges,width = 0.2, position = "left", ncol = 3, stepY = 50)



##try to dashboard this? 
#install.packages("flexdashboard", type = "source")

##us map 
install.packages('usmap')

library(usmap)

plot_usmap('counties', include = c(.mid_atlantic, .new_england ) ) 

county_info <- edges$county %>% stringr::str_split(pattern = ", ") %>% unlist() %>% unique()
 
counties <- usmap::us_map(regions = "counties", include= c(.mid_atlantic, .new_england)) 
counties %<>% mutate(beenthere = ifelse(county %in% county_info, T,F))
table(counties$beenthere)

coul_2  <- brewer.pal(2, "Pastel2") 
# Create a vector of color
my_color_2 <- coul_2[as.numeric(as.factor(counties$beenthere))]

p <-plot_usmap(regions = 'counties', include= c(.mid_atlantic, .new_england), 
           fill = my_color_2, alpha = .7)+ 
  geom_point(data = counties, aes(x = x, y = y, text = county),alpha = 0) + 
  labs(title = 'Places Ive Been')

ggplotly(p, tooltip = c('text')) 


ggplot() +
  geom_polygon(data = counties, aes(x=x, y = y), fill=my_color_2)+
  theme_void() + ylim(50,59)  coord_map() +
  theme(legend.position="none")


length(unique(counties$county[counties$beenthere == T]))

####Read in nyc github data
#install.packages('curl')
library(curl)
tests_day <- read.csv( curl("https://raw.githubusercontent.com/nychealth/coronavirus-data/master/tests.csv") )
tests_day$DATE %<>% lubridate::mdy()


##recent data by zip
zip_4weeks <- read.csv( curl("https://raw.githubusercontent.com/nychealth/coronavirus-data/master/recent/recent-4-week-by-modzcta.csv") )
zip_2_boro <- read.csv('~/Desktop/network_graph/zip_borough.csv')


##first get the rates per borough over the last 4 weeks
boro_4weeks <- zip_4weeks %>% select(MODIFIED_ZCTA, NEIGHBORHOOD_NAME,PERCENT_POSITIVE_4WEEK, starts_with("COVID"))

boro_4weeks %<>% rename(zip = MODIFIED_ZCTA)
boro_4weeks %<>% left_join(., zip_2_boro, by = "zip")

boro_4weeks_avg <- boro_4weeks %>% group_by(borough) %>%
  select(-zip, -NEIGHBORHOOD_NAME,-COVID_CASE_RATE_4WEEK) %>%
  summarise_all(mean,na.rm= T) %>%
  reshape2::melt(id.vars = c("borough", "PERCENT_POSITIVE_4WEEK",'COVID_DEATH_COUNT_4WEEK','COVID_DEATH_RATE_4WEEK'))


boro_4weeks_avg %<>%mutate(variable = factor(variable,levels = c("COVID_CASE_COUNT_WEEK4", "COVID_CASE_COUNT_WEEK3", "COVID_CASE_COUNT_WEEK2", "COVID_CASE_COUNT_WEEK1"))) 

boro_4weeks_avg$variable <- plyr::revalue(boro_4weeks_avg$variable, c("COVID_CASE_COUNT_WEEK4"="4 weeks ago",
                                                                      "COVID_CASE_COUNT_WEEK3"="3 weeks ago",
                                                                      'COVID_CASE_COUNT_WEEK2' = '2 weeks ago',
                                                                      'COVID_CASE_COUNT_WEEK1' = '1 week ago'))

library(ggmap)
register_google(key = "AIzaSyBboTL3XIXob3NSf4hgB4aydtqVqk6p2k8", write = TRUE)



#graph 1, overall case counts
pos_day <- tests_day %>%
  dplyr::select(DATE, PERCENT_POSITIVE_7DAYS_AVG, POSITIVE_TESTS_7DAYS_AVG) %>%
  rename(date = DATE, positive_rate = PERCENT_POSITIVE_7DAYS_AVG, total_positive_tests = POSITIVE_TESTS_7DAYS_AVG) %>%
  mutate(positive_rate = positive_rate*100)%>%
  ggplot(aes(x = date,label = positive_rate)) +
  geom_line(aes(y = total_positive_tests, color = 'red'), size = 1.2, show.legend = F) +
  ylab("total positive tests") +
  theme_minimal()+
  labs(title = "Citywide Daily Case Count") +
  theme(legend.position='none')
pos_day %>%
  ggplotly(tooltip = c("date","label"))

#graph2: by borough over the last 4 weeks
boro <- boro_4weeks_avg %>%
  filter(variable != "COVID_CASE_COUNT_4WEEK") %>%
  filter(!is.na(borough)) %>%
  filter(!grepl("COVID_CASE_RATE",variable)) %>%
  rename(number_of_cases = value) %>% 
  ggplot(aes(x = variable)) +
  geom_line(aes(y = number_of_cases, group = borough, color = borough), size = 1.2) +
  xlab('week') +
  ylab('number of cases') + 
  labs(title = "Borough Case Count", subtitle = 'Over the Last 4 Weeks') +
  theme_minimal()

boro %>% ggplotly(tooltip = c('number_of_cases'))

##by neighborhood

nyc_map <- get_map(location = c(lon = -74.00, lat = 40.71), maptype = "terrain", zoom = 11)

formap <- zip_4weeks %>% select(MODIFIED_ZCTA,NEIGHBORHOOD_NAME,PERCENT_POSITIVE_4WEEK,COVID_CASE_COUNT_4WEEK)

#gc <- do.call(rbind,
              #(formap, 1, function(x){geocode(location = paste(x[1], x[2], sep = ", "), 
                                                #source = "google")})
#)

#write.csv(gc,'~/Desktop/network_graph/latlong.csv',row.names = F)
gc <- read.csv('~/Desktop/network_graph/latlong.csv')
formap <- cbind(formap, gc)
formap %<>% rename(percent_positive = PERCENT_POSITIVE_4WEEK, case_count = COVID_CASE_COUNT_4WEEK)

t <- ggmap(nyc_map) + geom_point(
    aes(x=lon, y=lat, colour=percent_positive, size =percent_positive,
        text = paste(NEIGHBORHOOD_NAME, "<br>", "Case Count:", case_count,"<br>", "Percent Positive:",percent_positive)),
    data=formap, na.rm = T,show.legend =F)  + 
  scale_color_gradient() + 
  theme(legend.position='none',
        axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks = element_blank(),
        rect = element_blank(),
        axis.title.y=element_blank(),axis.title.x=element_blank())


t %>% ggplotly(tooltip = c('text'))



